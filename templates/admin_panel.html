{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Dino — Panel de administración</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons para íconos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- Navbar -->
  <nav class="navbar navbar-light bg-white border-bottom shadow-sm px-4 py-3">
    <a class="navbar-brand d-flex align-items-center fw-bold fs-5">
      <img src="{% static 'img/logo_dino.png' %}" alt="Logo" width="150" class="me-2">
      | Panel de administración
    </a>
    <div class="d-flex align-items-center gap-4">
      <span class="text-success fw-medium d-flex align-items-center">
        <i class="bi bi-circle-fill me-1" style="font-size: 0.6rem;"></i> En línea como staff: {{ request.user.get_full_name|default:request.user.username }}
      </span>
      <form action="{% url 'logout' %}" method="post" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-dark btn-sm">
          <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
        </button>
      </form>
    </div>
  </nav>

<div class="container">
    <h2>Panel de Administración</h2>
    <p>Gestiona empleados, evaluaciones y reportes del sistema</p>

    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumen" type="button" role="tab">Resumen</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="empleados-tab" data-bs-toggle="tab" data-bs-target="#empleados" type="button" role="tab">Empleados</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="evaluaciones-tab" data-bs-toggle="tab" data-bs-target="#evaluaciones" type="button" role="tab">Evaluaciones</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="incidencias-tab" data-bs-toggle="tab" data-bs-target="#incidencias" type="button" role="tab">Incidencias</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button" role="tab">Roles</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes" type="button"
                role="tab">Reportes</button>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="autoevaluaciones-tab" href="{% url 'realizar_autoevaluacion' %}"
                role="tab">Autoevaluaciones</a>
        </li>
        </ul>

    <div class="tab-content mt-3" id="adminTabsContent">
        <!-- Resumen -->
        <div class="tab-pane fade show active" id="resumen" role="tabpanel" aria-labelledby="resumen-tab">
            <h4>Resumen</h4>

            <!-- Info sesión -->
            <div class="card mb-4" style="background-color: #e7f1ff; border-radius: 8px; padding: 20px;">
              <h5><i class="bi bi-shield-lock"></i> Información de Sesión</h5>
              <div class="row mt-3">
                <div class="col-md-4">
                  <strong>Usuario</strong><br>
                  {{ request.user.get_full_name|default:request.user.username }}
                </div>
                <div class="col-md-4">
                  <strong>Email</strong><br>
                  {{ request.user.email }}
                </div>
                <div class="col-md-4">
                  <strong>Rol</strong><br>
                  <span class="badge bg-primary" style="font-size: 0.9em;">
                    {% if request.user.rol %}
                      {{ request.user.rol }}
                    {% else %}
                      Sin rol
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>

            <!-- Estadísticas resumen -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card shadow-sm p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Total Empleados</span>
                            <i class="bi bi-people-fill fs-4"></i>
                        </div>
                        <h3>{{ total_empleados }}</h3>
                        <small class="text-muted">+2 este mes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Evaluaciones Completadas</span>
                            <i class="bi bi-file-text fs-4"></i>
                        </div>
                        <h3>{{ total_evaluaciones_cliente }}</h3>
                        <small class="text-muted">Este mes</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Incidencias Activas</span>
                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                        </div>
                        <h3>{{ incidencias_activas }}</h3>
                        <small class="text-muted">-2 vs semana anterior</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Promedio General</span>
                            <i class="bi bi-graph-up fs-4"></i>
                        </div>
                        <h3>{{ promedio_general }}</h3>
                        <small class="text-muted">+3.2% vs mes anterior</small>
                    </div>
                </div>
            </div>

            <!-- Top empleados e incidencias recientes -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm p-3 mb-4">
                        <h5>Top Empleados</h5>
                        <p class="text-muted">Mejores calificaciones este mes</p>
                        <ul class="list-group list-group-flush">
                            {% for empleado in top_empleados %}
                            <li class="list-group-item d-flex align-items-center">
                                <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-3" style="width: 40px; height: 40px;">
                                    {{ empleado.iniciales }}
                                </div>
                                <div class="flex-grow-1">
                                    <strong>{{ empleado.nombre }}</strong><br>
                                    <small class="text-muted">{{ empleado.area }}</small>
                                </div>
                                <span class="badge bg-dark rounded-pill">{{ empleado.puntaje }} pts</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card shadow-sm p-3 mb-4">
                        <h5>Incidencias Recientes</h5>
                        <p class="text-muted">Últimos reportes de clientes</p>
                        <ul class="list-group list-group-flush">
                            {% for incidencia in incidencias_recientes %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ incidencia.empleado }}</strong><br>
                                    <small>{{ incidencia.descripcion }}</small>
                                </div>
                                <span class="badge 
                                    {% if incidencia.estado == 'Abierta' %}bg-danger
                                    {% elif incidencia.estado == 'En proceso' %}bg-warning text-dark
                                    {% elif incidencia.estado == 'Cerrada' %}bg-secondary
                                    {% else %}bg-light text-dark
                                    {% endif %}
                                    rounded-pill">
                                    {{ incidencia.estado }}
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empleados -->
<div class="tab-pane fade" id="empleados" role="tabpanel" aria-labelledby="empleados-tab">
    <h4>Gestión de Empleados</h4>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <button class="btn btn-dark d-flex align-items-center gap-2">
            <i class="bi bi-person-plus-fill"></i> Agregar Empleado
        </button>
        <div class="d-flex gap-2">
            <input type="search" class="form-control" placeholder="Buscar empleados..." style="min-width: 250px;">
            <button class="btn btn-outline-secondary d-flex align-items-center gap-1">
                <i class="bi bi-funnel-fill"></i> Filtros
            </button>
        </div>
    </div>

    <ul class="list-group">
        {% for emp in empleados %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center" style="width: 40px; height: 40px; font-weight: 700;">
                    {{ emp.username|slice:":2"|upper }}
                </div>
                <div>
                    <div style="font-weight: 600;">{{ emp.get_full_name|default:emp.username }}</div>
                    <small class="text-muted">{{ emp.rol|title }}</small>
                </div>
            </div>
            <div class="d-flex align-items-center gap-4">
                <div class="text-center">
                    <div style="font-weight: 600;">85</div>
                    <small class="text-muted">Promedio</small>
                </div>
                <div class="text-center">
                    <div style="font-weight: 600;">12</div>
                    <small class="text-muted">Evaluaciones</small>
                </div>
                <div class="text-center">
                    <div style="font-weight: 600; color: red;">1</div>
                    <small class="text-muted">Incidencias</small>
                </div>
                <button class="btn btn-outline-primary btn-sm">Ver Detalles</button>
            </div>
        </li>
        {% empty %}
        <li class="list-group-item text-center text-muted">No hay empleados disponibles.</li>
        {% endfor %}
    </ul>
</div>


<div class="tab-pane fade" id="evaluaciones" role="tabpanel" aria-labelledby="evaluaciones-tab">
    <h4>Gestión de Evaluaciones</h4>
    <div class="d-flex gap-3 flex-wrap justify-content-between">
        <!-- Evaluación Cliente -->
        <div class="card shadow-sm p-3 d-flex flex-column justify-content-between" style="flex: 1 1 32%; max-width: 33%;">
            <div>
                <h5 class="card-title fw-bold">Evaluación Cliente</h5>
                <p class="card-subtitle mb-3 text-muted">Evaluaciones de clientes a empleados</p>
                <ul class="list-unstyled mb-4">
                    <li><strong>Completadas:</strong> {{ evaluacion_cliente.completadas }}</li>
                    <li><strong>Pendientes:</strong> {{ evaluacion_cliente.pendientes }}</li>
                    <li><strong>Promedio:</strong> {{ evaluacion_cliente.promedio }}</li>
                </ul>
            </div>
            <button class="btn btn-dark w-100 mt-auto">Configurar</button>
        </div>

        <!-- Evaluación Gerencial -->
        <div class="card shadow-sm p-3 d-flex flex-column justify-content-between" style="flex: 1 1 32%; max-width: 33%;">
            <div>
                <h5 class="card-title fw-bold">Evaluación Gerencial</h5>
                <p class="card-subtitle mb-3 text-muted">Evaluaciones de gerentes a empleados</p>
                <ul class="list-unstyled mb-4">
                    <li><strong>Completadas:</strong> {{ evaluacion_gerencial.completadas }}</li>
                    <li><strong>Pendientes:</strong> {{ evaluacion_gerencial.pendientes }}</li>
                    <li><strong>Promedio:</strong> {{ evaluacion_gerencial.promedio }}</li>
                </ul>
            </div>
            <button class="btn btn-dark w-100 mt-auto">Configurar</button>
        </div>

        <!-- Autoevaluación -->
        <div class="card shadow-sm p-3 d-flex flex-column justify-content-between" style="flex: 1 1 32%; max-width: 33%;">
            <div>
                <h5 class="card-title fw-bold">Autoevaluación</h5>
                <p class="card-subtitle mb-3 text-muted">Autoevaluaciones de empleados</p>
                <ul class="list-unstyled mb-4">
                    <li><strong>Completadas:</strong> {{ autoevaluacion.completadas }}</li>
                    <li><strong>Pendientes:</strong> {{ autoevaluacion.pendientes }}</li>
                    <li><strong>Promedio:</strong> {{ autoevaluacion.promedio }}</li>
                </ul>
            </div>
            <button class="btn btn-dark w-100 mt-auto">Configurar</button>
        </div>
    </div>
</div>

        <!-- Incidencias -->
<div class="tab-pane fade" id="incidencias" role="tabpanel" aria-labelledby="incidencias-tab">
    <h4>Gestión de Incidencias</h4>
    <div class="list-group">
        {% for incidencia in incidencias %}
        <div class="list-group-item d-flex justify-content-between align-items-center rounded mb-3 shadow-sm">
            <div class="d-flex flex-column">
                <strong>{{ incidencia.titulo }}</strong>
                <span>
                    Empleado: {{ incidencia.empleado.get_full_name|default:incidencia.empleado.username }}
                </span>
            </div>
            <div class="d-flex flex-column text-center">
                <span>Cliente: {{ incidencia.cliente.nombre }}</span>
                <span>Fecha: {{ incidencia.fecha|date:"Y-m-d" }}</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                {% if incidencia.estado == 'abierta' %}
                <span class="badge rounded-pill bg-danger">Abierta</span>
                {% elif incidencia.estado == 'en_proceso' %}
                <span class="badge rounded-pill bg-warning text-dark">En proceso</span>
                {% elif incidencia.estado == 'cerrada' %}
                <span class="badge rounded-pill bg-dark">Cerrada</span>
                {% else %}
                <span class="badge rounded-pill bg-secondary">Desconocido</span>
                {% endif %}
                <a href="{% url 'ver_incidencia' incidencia.id %}" class="btn btn-outline-secondary btn-sm">Ver</a>
                <a href="{% url 'gestionar_incidencia' incidencia.id %}" class="btn btn-primary btn-sm">Gestionar</a>
            </div>
        </div>
        {% empty %}
        <p>No hay incidencias registradas.</p>
        {% endfor %}
    </div>
</div>


        <!-- Roles -->
<div class="tab-pane fade" id="roles" role="tabpanel" aria-labelledby="roles-tab">
    <h4>Gestión de Roles</h4>
    <button class="btn btn-dark mb-3 float-end"><i class="bi bi-shield-lock"></i> Crear Rol</button>
    <div class="list-group">
        {% for rol in roles %}
        <div class="list-group-item d-flex justify-content-between align-items-center mb-2 rounded shadow-sm">
            <div>
                <h5 class="mb-1">{{ rol.nombre }} 
                    <span class="badge rounded-pill bg-{{ rol.nombre|lower }}">
                        {{ rol.nombre }}
                    </span>
                </h5>
                <small class="text-muted">Acceso
                    {% if rol.nombre == "Administrador" %}
                        completo al sistema
                    {% elif rol.nombre == "Gerente" %}
                        de equipos y evaluaciones
                    {% else %}
                        básico para empleados
                    {% endif %}
                </small>
                <div class="mt-2">
                    <span class="badge bg-secondary me-1"><i class="bi bi-people"></i> {{ rol.usuarios.count }} Usuarios</span>
                    {% if rol.nombre == "Administrador" %}
                        <span class="badge bg-primary me-1">Gestión completa</span>
                        <span class="badge bg-primary me-1">Reportes</span>
                        <span class="badge bg-primary me-1">Usuarios</span>
                    {% elif rol.nombre == "Gerente" %}
                        <span class="badge bg-info me-1">Evaluaciones</span>
                        <span class="badge bg-info me-1">Reportes</span>
                        <span class="badge bg-info me-1">Incidencias</span>
                    {% else %}
                        <span class="badge bg-success me-1">Ver evaluaciones</span>
                        <span class="badge bg-success me-1">Autoevaluación</span>
                    {% endif %}
                </div>
            </div>
            <div>
                <small class="text-muted d-block mb-1">Usuarios</small>
                <a href="#" class="btn btn-outline-primary btn-sm">Editar</a>
            </div>
        </div>
        {% empty %}
        <p>No hay roles registrados.</p>
        {% endfor %}
    </div>
</div>


        <!-- Reportes -->
<div class="tab-pane fade" id="reportes" role="tabpanel" aria-labelledby="reportes-tab">
  <h4>Reportes y Análisis</h4>
  <p class="text-muted mb-4">Genera reportes detallados del desempeño</p>

  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-dark">
      <i class="bi bi-download me-2"></i> Exportar Todo
    </button>
  </div>

  <div class="card p-3 mb-3">
    <h5>Configurar Reportes</h5>
    <form class="row g-3">
      <div class="col-md-3">
        <label for="fecha_desde" class="form-label">Fecha Desde</label>
        <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" placeholder="Seleccionar">
      </div>
      <div class="col-md-3">
        <label for="fecha_hasta" class="form-label">Fecha Hasta</label>
        <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" placeholder="Seleccionar">
      </div>
      <div class="col-md-3">
        <label for="departamento" class="form-label">Departamento</label>
        <select id="departamento" name="departamento" class="form-select">
          <option selected>Seleccionar</option>
          <!-- Opciones de departamentos -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="formato" class="form-label">Formato</label>
        <select id="formato" name="formato" class="form-select">
          <option selected>PDF</option>
          <option>Excel</option>
          <option>CSV</option>
        </select>
      </div>
    </form>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h6><i class="bi bi-graph-up"></i> Reporte de Desempeño</h6>
        <p class="text-muted">Análisis completo por empleado</p>
        <button class="btn btn-dark w-100">Generar Reporte</button>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h6><i class="bi bi-file-text"></i> Reporte de Incidencias</h6>
        <p class="text-muted">Análisis de problemas reportados</p>
        <button class="btn btn-dark w-100">Generar Reporte</button>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h6><i class="bi bi-people"></i> Reporte Departamental</h6>
        <p class="text-muted">Análisis por departamento</p>
        <button class="btn btn-dark w-100">Generar Reporte</button>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h6><i class="bi bi-calendar-event"></i> Reporte Mensual</h6>
        <p class="text-muted">Resumen ejecutivo mensual</p>
        <button class="btn btn-dark w-100">Generar Reporte</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>